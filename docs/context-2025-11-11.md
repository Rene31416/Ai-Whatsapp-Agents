# Context — 2025-11-11

## Phase 1 Recap (Tenant identity)
- Added `TenantRepository` that reads `TenantClinicMetadata` via PK (`tenantId`) and `PhoneNumberIdIndex` for reverse lookups.
- Webhook now resolves `phone_number_id → tenantId`, stamps `tenantId` into SQS messages, and rejects unknown numbers.
- ChatService/Whatsapp/Calendar services fetch tenant secrets via metadata (no more string concatenation with phone IDs).
- Local REPL requires `LOCAL_PHONE_NUMBER_ID` or `LOCAL_TENANT_ID` and performs the same metadata lookup before sending fake SQS events.
- Env vars documented in `docs/env-vars.md`; new `TENANT_TABLE_NAME`/`TENANT_GSI_PHONE` are required everywhere the repo is used.

## Appointments foundation
- Dynamo table `Appointments` (PK `PK=TENANT#id`, SK `SK=APPT#id`) with GSIs for user (`UserAppointmentsIndex`), doctor (`DoctorScheduleIndex`), and status (`StatusIndex`).
- Short appointment IDs generated via random base32 alphabet (8 chars) and stored in each record.
- Repository (`src/services/appointments.repository.ts`) encapsulates CRUD/query helpers and overlap validation.
- Service (`src/services/appointments.service.ts`) enforces business rules: availability checks, dual lookup for reschedule/cancel (by `appointmentId` or `tenant+user+doctor+startIso`), and standard responses.
- Controller + Lambda handler (`src/controller/appointments.controller.ts`, `src/app/lambda-handlers/appointments.ts`) expose:
  - `POST /appointments`
  - `PATCH /appointments` (optional path param) for reschedule
  - `DELETE /appointments` (optional path param)
  - `GET /appointments/availability?tenantId=...&(doctorId|userId)=...&from=...&to=...`
- CDK wires `AppointmentsLambda` to API Gateway `/appointments` routes, grants table permissions, and injects env vars.
- `chatServiceLambda` now receives `APPOINTMENTS_API_BASE_URL` (API Gateway URL + `/appointments`) for future tool calls.

## Prompt/tool changes
- Removed Google Calendar tools; new `appointments_*` tools call the REST API via `fetch`.
- Calendar prompt instructions updated to mention the new tool names and flows (check availability → collect data → `appointments_create`, plus reschedule/cancel variants).
- Tool args helpers normalize doctor IDs, fallback to policy state, enforce `userId`, `startIso`, etc.
- Error handling converts HTTP 409/404 errors into friendly WhatsApp responses.

## Outstanding work / Next steps
1. **Deploy & seed**: redeploy the stack so the new Lambda/API/table exist; seed tenant metadata and any initial appointments if needed.
2. **LLM/tool wiring**: update the dentist workflow/prompt instructions (if any remain elsewhere) so the model calls these tools at the right time. Verify the JSON contract with the chosen LLM (Gemini today). Add evaluations with sample chats.
3. **UI integration**: the new Figma-generated UI will call these endpoints; ensure auth/tenant scoping and pagination logic are in place.
4. **Eventing**: add EventBridge/SQS outputs from appointments service for calendar sync + notifications (future work, once calendar integration is moved to the async path).
5. **Legacy cleanup**: aggregator/flush lambdas still reference the buffer table; keep them disabled for now but eventually remove or modernize.

## Testing status / Caveats
- `pnpm tsc --noEmit` still fails because `@aws-sdk/lib-dynamodb` pulls conflicting `@smithy/types` versions (upstream issue). No runtime tests executed yet.
- The API currently has no auth; gating by tenant metadata or API key is still pending.
- Appointment tools assume `doctorId` is either `gerardo` or `amada`; extend mapping if more doctors are added.

## Handy references
- Tenant metadata example (Dynamo item) and env vars: `docs/env-vars.md`.
- Appointments table CDK block: `lib/ai-agents-stack.ts` lines ~69–120 and 326–369.
- Prompt/tool logic: `src/prompts/calendar.prompt.ts`, `src/prompts/appointments.tools.ts`.
- Controller/service entry points: `src/controller/appointments.controller.ts`, `src/services/appointments.service.ts`.

Keep this file updated as we move into Phase 2 (appointments UI + async calendar sync).
